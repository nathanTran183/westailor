<div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
        <%
        // message the validation
        if (messages.errors) {
        for (i = 0; i < messages.errors.length; i++) {
        %>
        <div class="alert alert-danger">
            <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
            <strong>Fail !</strong> <%= messages.errors[i].msg %>
        </div>
        <%
        }
        }

        // message the reason change password fail
        if (messages.reason_fail) {
        %>
        <div class="alert alert-warning">
            <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
            <%= messages.reason_fail %>
        </div>
        <%
        }

        // message if success
        if (messages.success) {
        %>
        <div class="alert alert-success">
            <a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
            <%= messages.success %>
        </div>
        <%
        }
        %>

        <h1>
            Process Order
        </h1>
        <ol class="breadcrumb">
            <li><a href="/orders"><i class="fa fa-building"></i>Orders</a></li>
            <li class="active">Order Detail</li>
        </ol>
    </section>

    <section class="invoice">
        <!-- title row -->
        <div class="row">
            <div class="col-xs-12">
                <h2 class="page-header">
                    <i class="fa fa-globe"></i> Order: <%= order._id %>
                </h2>
            </div>
            <!-- /.col -->
        </div>
        <!-- info row -->
        <div class="row invoice-info">
            <div class="col-sm-4 invoice-col">
                <h4>Shipping Information</h4>
                <address>
                    <b>Receiver: </b><b style="text-transform: uppercase"><%= order.shipping.name %></b><br>
                    <b>Address: </b><%= order.shipping.address %><br>
                    <b>City: </b><%= order.shipping.city %><br>
                    <b>Zip code: </b><%= order.shipping.zipcode %><br>
                    <b>Country: </b><%= order.shipping.country %><br>
                    <% if(order.shipping.provinces) { %><b>Province: </b><%= order.shipping.province %><br><% } %>
                    <b>Phone: </b><%= order.shipping.phone %>
                </address>
            </div>
            <!-- /.col -->
            <div class="col-sm-4 invoice-col">
                <h4>Order Detail</h4>
                <address>
                    <b>Order ID</b><%= order._id %><br>
                    <b>Order Date:</b> <%= order.createdAt.toLocaleString() %><br>
                    <b>Bag Price:</b> <%= order.bag_price %><br>
                    <% if(order.discount_id) { %><b>Discount:</b> <%= order.discount_id %><br><% } %>
                    <b>Ship Fee:</b> <%= order.ship_fee %><br>
                    <b>Total Amount:</b> <%= order.total_price %><br>
                    <b>Status:</b><% if(order.status == 1) { %> <span class="label label-danger">Pending</span>
                    <%} if(order.status==2){ %> <span class="label label-warning">Confirmed</span> <%} 
                        if(order.status==3){ %> <span class="label label-default">Processing</span> <%} 
                        if(order.status==4){ %> <span class="label label-primary">Delivering</span> <%} 
                        if(order.status==5){ %> <span class="label label-success">Done</span> <% } %></span>
                </address>
            </div>
            <!-- /.col -->
            <div class="col-sm-4 invoice-col">
                <h4>Other info</h4>
                <address>
                    <b>Transaction ID:</b> <%= order.transaction_id %><br>
                    <% if(!!order.user_id) { %>
                    <b>Buyer ID:</b> <%= order.user_id._id %><br>
                    <b>Buyer Name:</b> <%= order.user_id.full_name %><br>
                    <b>Buyer Phone:</b> <%= order.user_id.phone_number %><br>
                    <% } %>
                </address>
            </div>
            <!-- /.col -->
        </div>
        <!-- /.row -->

        <!-- Table row -->
        <div class="row">
            <div class="col-xs-12 table-responsive">
                <p class="lead">Product Information</p>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th></th>
                            <th>Product</th>
                            <th>Fabric</th>
                            <th>Detail</th>
                            <th>Measure</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <% if(order.status == 1) { %><th>Status</th> <% } %>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        <% 
                            let disable = false;
                            var i = 1; order.order_item.forEach(function (orderDetail) {
                                if (order.status == 1 && orderDetail.status == false || order.status == 5) {
                                    disable = true; }
                        %>
                        <tr>
                            <td><%= i++ %></td>
                            <td><%= orderDetail.item_id.name %></td>
                            <td>
                                Code: <b><%= orderDetail.fabric_id.code %></b><br>
                                Name: <b><%= orderDetail.fabric_id.name %></b>
                            </td>

                            <td>
                                <%  orderDetail.products.forEach(product => { %>
                                    <b style="text-transform: uppercase"><%= product.product_id.name %></b><br>
                                <%
                                Object.keys(product.style).forEach(component => {
                                let type = product.product_id.components.find(comp => comp.code == component);
                                let value = type.componentItems.find(item => item.code == product.style[component])
                                %>
                                <%= type.name %>: <b><%= value.name %></b><br>
                                <% }) %>
                                <p></p>
                            <% }) %>
                            </td>

                            <td>
                                <%  orderDetail.products.forEach(product => { %>
                                    <b style="text-transform: uppercase"><%= product.product_id.name %></b><br>
                                <% if(!product.measure) { %>
                                <span class="label label-warning">No measure information</span>
                                <% } else { 
                                    Object.keys(product.measure).forEach(item => { %>
                                <%= item%>: <b><%= product.measure[item] %> (cm)</b><br>
                                <% }) %>
                                <p></p>
                                <% } }) %>
                            </td>

                            <td><%= orderDetail.quantity %></td>
                            <td><%= orderDetail.price %></td>
                            <% if(order.status == 1) { %>
                            <td><% if(orderDetail.status) { %> <span class="label label-success">Ready</span>
                                <% } else { %> <span class="label label-danger">Need Measure</span> <% } %>
                            </td>
                            <td><a title="Update measure" class="btn btn-primary fa fa-edit updateMeasure" data-toggle='modal' data-id="<%= orderDetail._id %>"></a></td><% } %>
                        </tr>
                        <% }) %>
                    </tbody>
                </table>
            </div>
            <!-- /.col -->
        </div>
        <!-- /.row -->

        <!-- this row will not appear when printing -->
        <div class="row no-print">
            <div class="col-xs-12">
                <% if (disable==false) {%>
                <button type="button" class="btn btn-success pull-right confirmConfirmOrder" data-toggle='modal'
                    data-id='<%= order._id %>' title='Confirm'>
                    <i class="fa fa-check-square"></i> Process
                </button>
                <% } %>
                <!-- <button type="button" class="btn btn-danger pull-right confirmCancelOrder" style="margin-right: 5px;"
                    data-toggle='modal' data-id='<%= order.id %>' title='Cancel'>
                    <i class="fa fa-minus-circle"></i> Cancel
                </button> -->
            </div>
        </div>
    </section>
</div>

<div class="modal fade" id="confirm-confirm-order" role="dialog">
    <form method="POST" id="form-confirm-order" action="/admin/orders/update/<%= order._id %>/change-status">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <% 
                        let status = "";
                        if(order.status == 1) {
                            status = "Confirm"
                        }
                        if(order.status == 2){              
                            status = "Processing"
                        }
                        if(order.status == 3) {
                            status = "Delivering"
                        }
                        if(order.status == 4) { 
                            status = "Done"
                        }
                    %>
                    <h3>Confirm to execute order to "<%= status %>"?</h3>
                </div>
                <div class="modal-body">
                    <input type="text" name="status" id="status" value="Confirmed" hidden="true">
                    Click on "Yes" to continue, "No" to cancel.
                </div>
                <div class="modal-footer">
                    <button type="button" id="exitModal" class="btn btn-danger" data-dismiss="modal">No</button>
                    <button type="submit" class="btn btn-primary">Yes</button>
                </div>
            </div>
        </div>
    </form>
</div>
<div class="modal fade" id="update-measure" role="dialog">
    <form method="POST" id="form-update-measure">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Update product measurement</h3>
                </div>
                <div class="modal-body">
                    <input type="text" name="status" id="status" value="Cancelled" hidden="true">
                    Click on "Yes" to continue, "No" to cancel.
                </div>
                <div class="modal-footer">
                    <button type="button" id="exitModal" class="btn btn-danger" data-dismiss="modal">No</button>
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            </div>
        </div>
    </form>
</div>
<script>
    $(document).ready(function() {
        $('.updateMeasure').click(function() {
            $('#update-measure .modal-body').empty();
            let orderItemId = $(this).data('id');
            let orderItems = <%- JSON.stringify(order.order_item) %>;
            let orderItem = orderItems.find(orderItem => orderItem._id == orderItemId);
            orderItem.product_id.measure.forEach(measurePart => {
                let measureVal = orderItem.measure ? orderItem.measure[measurePart] : "";
                let htmlStr = '<div class="form-group"><label for="'+measurePart+'" class="col-form-label">'+measurePart+':</label><input type="text" value="'+ measureVal +'" class="form-control" id="'+measurePart+'" name="'+measurePart+'"></div>'
                $('#update-measure .modal-body').append(htmlStr);
            });
            $('#update-measure form').attr('action',"/admin/orders/<%= order._id%>/orderItems/" + orderItemId + "/update")
            $('#update-measure').modal();
        })
    })
</script>
<!-- <div class="modal fade" id="confirm-cancel-order" role="dialog">
    <form method="POST" id="form-cancel-order" action="/admin/orders/<%= order.id %>">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Confirm to "Cancel" order?</h3>
                </div>
                <div class="modal-body">
                    <input type="text" name="status" id="status" value="Cancelled" hidden="true">
                    Click on "Yes" to continue, "No" to cancel.
                </div>
                <div class="modal-footer">
                    <button type="button" id="exitModal" class="btn btn-danger" data-dismiss="modal">No</button>
                    <button type="submit" class="btn btn-primary">Yes</button>
                </div>
            </div>
        </div>
    </form>
</div> -->